<%- include('layout', {body: `
<!-- Ä°statistik KartlarÄ± -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card bg-primary text-white">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Toplam ModeratÃ¶r</div>
                        <div class="h5 mb-0 font-weight-bold"><%= stats.totalModerators %></div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card bg-success text-white">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">BugÃ¼nkÃ¼ Atamalar</div>
                        <div class="h5 mb-0 font-weight-bold"><%= stats.todayAssignments %></div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-check fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card bg-warning text-white">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">BugÃ¼nkÃ¼ Mazeretler</div>
                        <div class="h5 mb-0 font-weight-bold"><%= stats.todayExcuses %></div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card bg-danger text-white">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">BoÅŸ Vardiyalar</div>
                        <div class="h5 mb-0 font-weight-bold"><%= stats.emptySlots %></div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- BugÃ¼nkÃ¼ Takvim -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-day me-2"></i>
                    BugÃ¼nkÃ¼ Takvim (<%= moment(today).format('DD.MM.YYYY') %>)
                </h6>
                <a href="/calendar" class="btn btn-sm btn-primary">
                    <i class="fas fa-edit me-1"></i>
                    DÃ¼zenle
                </a>
            </div>
            <div class="card-body">
                <% if (todayAssignments.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Vardiya</th>
                                    <th>ModeratÃ¶r</th>
                                    <th>Atama TÃ¼rÃ¼</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% todayAssignments.forEach(assignment => { %>
                                    <tr>
                                        <td>
                                            <% 
                                            const slotEmojis = {
                                                'slot1': 'ðŸŒš',
                                                'slot2': 'ðŸŒ…', 
                                                'slot3': 'â˜€ï¸',
                                                'slot4': 'ðŸŒ¤ï¸',
                                                'slot5': 'ðŸŒ†'
                                            };
                                            %>
                                            <span class="me-2"><%= slotEmojis[assignment.slot_id] %></span>
                                            <%= assignment.slot_name %>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar avatar-sm me-2">
                                                    <i class="fas fa-user-circle fa-lg text-primary"></i>
                                                </div>
                                                <div>
                                                    <strong><%= assignment.username %></strong>
                                                    <% if (assignment.display_name) { %>
                                                        <br><small class="text-muted"><%= assignment.display_name %></small>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <% if (assignment.assignment_type === 'automatic') { %>
                                                <span class="badge bg-success">Otomatik</span>
                                            <% } else if (assignment.assignment_type === 'manual_web') { %>
                                                <span class="badge bg-primary">Web Manuel</span>
                                            <% } else if (assignment.assignment_type === 'daily_survey') { %>
                                                <span class="badge bg-info">Anket</span>
                                            <% } else { %>
                                                <span class="badge bg-secondary">Manuel</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>
                                                AtandÄ±
                                            </span>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">BugÃ¼n iÃ§in henÃ¼z vardiya atamasÄ± yok</h5>
                        <p class="text-muted">Hemen bir takvim oluÅŸturun veya manuel atama yapÄ±n.</p>
                        <a href="/calendar" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Takvim OluÅŸtur
                        </a>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
    
    <!-- HÄ±zlÄ± Ä°ÅŸlemler & Bilgiler -->
    <div class="col-lg-4">
        <!-- HÄ±zlÄ± Ä°ÅŸlemler -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-bolt me-2"></i>
                    HÄ±zlÄ± Ä°ÅŸlemler
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="createTodaySchedule()">
                        <i class="fas fa-calendar-plus me-2"></i>
                        BugÃ¼n Ä°Ã§in Takvim OluÅŸtur
                    </button>
                    <button class="btn btn-primary" onclick="sendSurvey()">
                        <i class="fas fa-paper-plane me-2"></i>
                        Anket GÃ¶nder
                    </button>
                    <button class="btn btn-warning" onclick="sendAnnouncement()">
                        <i class="fas fa-bullhorn me-2"></i>
                        Duyuru Yap
                    </button>
                    <a href="/database" class="btn btn-info">
                        <i class="fas fa-database me-2"></i>
                        VeritabanÄ± Yedekle
                    </a>
                </div>
            </div>
        </div>
        
        <!-- BugÃ¼nkÃ¼ Mazeretler -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-warning">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    BugÃ¼nkÃ¼ Mazeretler
                </h6>
            </div>
            <div class="card-body">
                <% if (todayExcuses.length > 0) { %>
                    <% todayExcuses.forEach(excuse => { %>
                        <div class="border-left-warning shadow-sm p-3 mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-user text-warning me-2"></i>
                                <strong><%= excuse.username %></strong>
                                <small class="text-muted ms-auto"><%= moment(excuse.responded_at).format('HH:mm') %></small>
                            </div>
                            <p class="mb-0 small"><%= excuse.excuse %></p>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <p class="mb-0 text-muted">BugÃ¼n mazeret bildiren yok!</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- HaftalÄ±k Grafik -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-line me-2"></i>
                    HaftalÄ±k Aktivite
                </h6>
            </div>
            <div class="card-body">
                <canvas id="weeklyChart" width="100" height="30"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
// HaftalÄ±k grafik
const ctx = document.getElementById('weeklyChart').getContext('2d');
const weeklyChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'],
        datasets: [{
            label: 'Atama SayÄ±sÄ±',
            data: [4, 5, 3, 5, 4, 2, 3], // Bu veriler veritabanÄ±ndan gelecek
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }, {
            label: 'Mazeret SayÄ±sÄ±',
            data: [1, 0, 2, 0, 1, 3, 2],
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// HÄ±zlÄ± iÅŸlem fonksiyonlarÄ±
async function createTodaySchedule() {
    const today = '<%= today %>';
    
    if (confirm('BugÃ¼n iÃ§in yeni bir takvim oluÅŸturmak istediÄŸinizden emin misiniz?')) {
        try {
            const response = await fetch('/api/schedule/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ date: today })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Takvim baÅŸarÄ±yla oluÅŸturuldu!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showNotification('BaÄŸlantÄ± hatasÄ±!', 'error');
        }
    }
}

async function sendSurvey() {
    if (confirm('TÃ¼m moderatÃ¶rlere anket gÃ¶ndermek istediÄŸinizden emin misiniz?')) {
        try {
            const response = await fetch('/api/survey/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Anket gÃ¶nderildi!', 'success');
            } else {
                showNotification('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showNotification('BaÄŸlantÄ± hatasÄ±!', 'error');
        }
    }
}

function sendAnnouncement() {
    const message = prompt('Duyuru mesajÄ±nÄ±zÄ± yazÄ±n:');
    if (message && message.trim()) {
        // Duyuru gÃ¶nderme API'si
        showNotification('Duyuru gÃ¶nderildi!', 'success');
    }
}

// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', function() {
    // GerÃ§ek zamanlÄ± gÃ¼ncellemeler iÃ§in socket dinleyicileri
    socket.on('new_assignment', function(data) {
        showNotification(`Yeni atama: ${data.username} - ${data.slot_name}`, 'success');
        setTimeout(() => location.reload(), 2000);
    });
    
    socket.on('new_excuse', function(data) {
        showNotification(`Yeni mazeret: ${data.username}`, 'warning');
        setTimeout(() => location.reload(), 2000);
    });
});
</script>
`}) %> 